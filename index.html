<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tabulazione prove parallele IC Puddu</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Ubuntu', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #dfe5fc;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        h1 {
            text-align: center;
            color: #1a49e9;
            margin-bottom: 30px;
            font-size: 24px;
            position: relative;
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Aggiungi questa nuova regola dopo h1 */
        .header-logo {
            position: absolute;
            top: 0;
            right: 0;
            height: 100px;
            width: auto;
            opacity: 0.9;
            transition: opacity 0.3s ease;
        }

        .header-logo:hover {
            opacity: 1;
        }

        /* Responsive per mobile */
        @media (max-width: 768px) {
            h1 {
                flex-direction: column;
                min-height: auto;
                padding-top: 70px;
            }
            
            .header-logo {
                position: absolute;
                top: 0;
                left: 50%;
                transform: translateX(-50%);
                height: 60px;
            }
        }
        
        .form-header {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
            padding: 20px;
            background: #dfe5fc;
            border-radius: 8px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        label {
            font-weight: bold;
            margin-bottom: 5px;
            color: #333;
        }
        
        select, input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .table-container {
            overflow-x: auto;
            margin-bottom: 30px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        
        th {
            background-color: #3c78d8;
            color: white;
            font-weight: bold;
            text-align: center;
        }
        
        .header-yellow {
            background-color: #dfe5fc !important;
            color: black !important;
        }
        
        .header-blue {
            background-color: #3c78d8 !important;
            color: white !important;
        }
        
        .header-light-blue {
            background-color: #a4c2f4 !important;
            color: black !important;
        }
        
        /* Colori specifici per discipline */
        .header-italiano {
            background-color: #1c4587 !important;
            color: white !important;
        }
        
        .header-matematica {
            background-color: #9c1810 !important;
            color: white !important;
        }
        
        .header-inglese {
            background-color: #8e44ad !important;
            color: white !important;
        }
        
        .header-unica {
            background-color: #e9531a !important;
            color: white !important;
        }
        
        .score-warning {
            background-color: #ffebee !important;
            border: 2px solid #f44336 !important;
        }
        
        .instructions-box {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 5px;
            padding: 10px 15px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: bold;
            color: #856404;
        }
        
        .input-cell {
            background-color: #f9f9f9;
        }
        
        .score-input {
            width: 80px;
            text-align: center;
            border: 1px solid #ddd;
            padding: 5px;
        }
        
        .student-row {
            background-color: white;
        }
        
        .student-row:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        .add-student-btn {
            background-color: #06b698;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-bottom: 20px;
        }
        
        .add-student-btn:hover {
            background-color: #059d83;
        }
        
        .actions {
            display: flex;
            gap: 15px;
            margin-top: 30px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }
        
        .btn-primary {
            background-color: #06b640;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #059d37;
        }
        
        .btn-success {
            background-color: #06b640;
            color: white;
        }
        
        .btn-success:hover {
            background-color: #059d37;
        }
        
        .btn-warning {
            background-color: #dd5286;
            color: white;
        }
        
        .btn-warning:hover {
            background-color: #f71139;
        }
        
        .email-info {
            background-color: #ebfde8;
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
            border-left: 4px solid #06b640;
        }
        
        .email-info strong {
            color: #059d37;
        }
        
        .dashboard-info {
            background-color: #e8f4fd;
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
            border-left: 4px solid #3c78d8;
        }
        
        .dashboard-info strong {
            color: #3c78d8;
        }
        
        .discipline-fields {
            display: none;
        }
        
        .discipline-fields.active {
            display: table-cell;
        }
        
        .remove-student {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 3px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 11px;
        }
        
        .remove-student:hover {
            background-color: #c82333;
        }
    /* Stili per il sistema di autenticazione */
        .auth-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .auth-container {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            max-width: 400px;
            width: 90%;
            text-align: center;
        }

        .auth-container h2 {
            color: #1a49e9;
            margin-bottom: 30px;
        }

        .auth-input {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            box-sizing: border-box;
        }

        .auth-btn {
            background: #1a49e9;
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
            min-width: 120px;
        }

        .auth-btn:hover {
            background: #1435b8;
        }

        .auth-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .auth-message {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-size: 14px;
        }

        .auth-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .auth-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .user-info {
            background: #e8f4fd;
            padding: 10px 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            border-left: 4px solid #3c78d8;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logout-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }
        
        @media (max-width: 768px) {
            .form-header {
                grid-template-columns: 1fr;
            }
            
            .actions {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }
        }
        /* Stili per la sezione grafici */
        .charts-section {
            margin-top: 40px;
            padding: 30px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .charts-header {
            text-align: center;
            color: #1a49e9;
            margin-bottom: 30px;
            font-size: 24px;
        }

        .chart-controls {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
        }

        .filter-group {
            margin-bottom: 20px;
        }

        .filter-group h4 {
            color: #3c78d8;
            margin-bottom: 10px;
        }

        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .checkbox-item:hover {
            background: #e8f4fd;
            border-color: #3c78d8;
        }

        .checkbox-item input[type="checkbox"] {
            margin: 0;
        }

        .charts-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }

        .chart-wrapper {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            text-align: center;
            min-height: 450px;
        }

        .chart-title {
            color: #3c78d8;
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
        }

        .chart-canvas {
            max-width: 100%;
            height: 450px !important;
        }

        .chart-actions {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .btn-chart {
            background: #3c78d8;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }

        .btn-chart:hover {
            background: #2a5cb8;
        }

        .btn-chart-secondary {
            background: #3c78d8;
            color: white;
        }

        .btn-chart-secondary:hover {
            background: #2a5cb8;
        }

        .stats-summary {
            background: #e8f4fd;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }

        .stats-summary h4 {
            color: #3c78d8;
            margin: 0 0 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>
            <img src="https://raw.githubusercontent.com/Emanuele-ElBasri/pp-puddu/refs/heads/main/ICS_Puddu_logo.svg" 
            alt="Logo IC Puddu" 
            class="header-logo">
            Tabulazione prove parallele IC Puddu
        </h1>

        <!-- Barra informazioni utente -->
        <div id="userInfo" class="user-info" style="display: none;">
            <span>üë§ Connesso come: <strong id="userEmail"></strong></span>
            <button onclick="logout()" class="logout-btn">Esci</button>
        </div>
        
        <div class="form-header">
            <div class="form-group">
                <label for="anno">Anno Scolastico:</label>
                <select id="anno">
                    <option value="2019/2020">2019/2020</option>
                    <option value="2020/2021">2020/2021</option>
                    <option value="2021/2022">2021/2022</option>
                    <option value="2022/2023">2022/2023</option>
                    <option value="2024/2025">2024/2025</option>
                    <option value="2025/2026" selected>2025/2026</option>
                    <option value="2026/2027">2026/2027</option>
                    <option value="2027/2028">2027/2028</option>
                    <option value="2028/2029">2028/2029</option>
                    <option value="2029/2030">2029/2030</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="ordine">Ordine:</label>
                <select id="ordine">
                    <option value="">Seleziona ordine</option>
                    <option value="Infanzia">Infanzia</option>
                    <option value="Primaria">Primaria</option>
                    <option value="Secondaria I grado">Secondaria I grado</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="plesso">Plesso:</label>
                <select id="plesso">
                    <option value="">Seleziona plesso</option>
                    <option value="C. Puddu">C. Puddu</option>
                    <option value="G. Rodari">G. Rodari</option>
                    <option value="Don Bosco">Don Bosco</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="classe">Classe/Anno:</label>
                <select id="classe">
                    <option value="">Seleziona classe o anno</option>
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5">5</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="sezione">Sezione:</label>
                <select id="sezione">
                    <option value="">Seleziona sezione</option>
                    <option value="A">A</option>
                    <option value="B">B</option>
                    <option value="C">C</option>
                    <option value="D">D</option>
                    <option value="E">E</option>
                    <option value="F">F</option>
                    <option value="G">G</option>
                    <option value="H">H</option>
                    <option value="I">I</option>
                    <option value="J">J</option>
                    <option value="K">K</option>
                    <option value="L">L</option>
                    <option value="M">M</option>
                    <option value="N">N</option>
                    <option value="O">O</option>
                    <option value="P">P</option>
                    <option value="Q">Q</option>
                    <option value="R">R</option>
                    <option value="S">S</option>
                    <option value="T">T</option>
                    <option value="U">U</option>
                    <option value="V">V</option>
                    <option value="W">W</option>
                    <option value="X">X</option>
                    <option value="Y">Y</option>
                    <option value="Z">Z</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="prova">Tipo di Prova:</label>
                <select id="prova">
                    <option value="Iniziale">Iniziale</option>
                    <option value="Intermedia">Intermedia</option>
                    <option value="Finale">Finale</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="disciplina">Disciplina:</label>
                <select id="disciplina">
                    <option value="Inglese">Inglese</option>
                    <option value="Italiano">Italiano</option>
                    <option value="Matematica">Matematica</option>
                    <option value="Unica">Unica (Infanzia)</option>
                </select>
            </div>
        </div>
        
        <div class="instructions-box">
            ‚ö†Ô∏è INSERIRE I PUNTEGGI SU BASE 100
        </div>
        <div class="table-container">
            <table id="studentsTable">
                <thead>
                    <tr>
                        <th style="background-color: #3c78d8;">COGNOME</th>
                        <th style="background-color: #3c78d8;">NOME</th>
                        <th style="background-color: #3c78d8;">CERTIFICATI</th>
                        <th style="background-color: #3c78d8;">COMPETENZE LINGUISTICHE</th>
                        
                        <!-- Inglese (solo 2 ambiti) -->
                        <th class="discipline-fields inglese-fields header-inglese">AMBITO 1<br>Comprensione scritta (Reading)</th>
                        <th class="discipline-fields inglese-fields header-inglese">AMBITO 2<br>Comprensione orale (Listening)</th>
                        
                        <!-- Italiano -->
                        <th class="discipline-fields italiano-fields header-italiano">AMBITO 1<br>Comprensione</th>
                        <th class="discipline-fields italiano-fields header-italiano">AMBITO 2<br>Inferenze</th>
                        <th class="discipline-fields italiano-fields header-italiano">AMBITO 3<br>Lessico</th>
                        <th class="discipline-fields italiano-fields header-italiano">AMBITO 4<br>Grammatica</th>
                        
                        <!-- Matematica Primaria (3 ambiti) -->
                        <th class="discipline-fields matematica-primaria-fields header-matematica">AMBITO 1<br>Numeri</th>
                        <th class="discipline-fields matematica-primaria-fields header-matematica">AMBITO 2<br>Spazio e Figure</th>
                        <th class="discipline-fields matematica-primaria-fields header-matematica">AMBITO 3<br>Relazioni, dati e previsioni</th>
                        
                        <!-- Matematica Secondaria (4 ambiti) -->
                        <th class="discipline-fields matematica-secondaria-fields header-matematica">AMBITO 1<br>Numeri</th>
                        <th class="discipline-fields matematica-secondaria-fields header-matematica">AMBITO 2<br>Spazio e Figure</th>
                        <th class="discipline-fields matematica-secondaria-fields header-matematica">AMBITO 3<br>Dati e Previsioni</th>
                        <th class="discipline-fields matematica-secondaria-fields header-matematica">AMBITO 4<br>Relazioni e Funzioni</th>
                        
                        <!-- Unica (Infanzia) -->
                        <th class="discipline-fields unica-fields header-unica">AMBITO 1<br>Comprensione</th>
                        <th class="discipline-fields unica-fields header-unica">AMBITO 2<br>Classificazione e Orientamento</th>
                        
                        <th class="header-blue">MEDIA</th>
                        <th style="background-color: #6e706e; color: white;">NOTE</th>
                        <th style="background-color: #6e706e; color: white;">AZIONI</th>
                    </tr>
                </thead>
                <tbody id="studentsTableBody">
                    <!-- Gli studenti saranno aggiunti dinamicamente qui -->
                </tbody>
            </table>
        </div>
        
        <div style="text-align: right">
            <button class="add-student-btn" onclick="addStudent()">+ Aggiungi Alunno</button>
        </div>
        
        <div class="actions">
            <button class="btn btn-primary" onclick="transmitData()">üì§ Trasmetti dati</button>
<button class="btn btn-success" onclick="saveExcel()">üíæ Salva Excel</button>
            <button class="btn btn-warning" onclick="clearAll()">üßπ Svuota Tutto</button>
        </div>
        
        <div class="email-info">
            <strong>‚úâÔ∏è Indirizzo per la restituzione:</strong> prove.didattica@pudduprato.edu.it
        </div>
        
        <div class="dashboard-info">
            <strong>üìä Guarda la dashboard d'Istituto</strong> <a href="https://datastudio.google.com/reporting/9f30bd14-3474-4020-acaf-831f73381a76" target="_blank">link alla dashboard</a>
        </div>
        <!-- Sezione Grafici -->
        <div class="charts-section" id="chartsSection">
            <h2 class="charts-header">üîç Analisi Grafici dei Risultati</h2>
            
            <div class="stats-summary" id="statsSummary">
                <h4>Riepilogo Dati</h4>
                <p>Alunni analizzati: <span id="totalStudents">0</span> | Media complessiva: <span id="overallAverage">-</span></p>
            </div>
            
            <div class="chart-controls">
                <div class="filter-group">
                    <h4>üîéFiltro per Certificazione</h4>
                    <div class="checkbox-group" id="certificatiFilters">
                        <label class="checkbox-item">
                            <input type="checkbox" value="no" checked>
                            <span>Nessuna certificazione</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" value="L. 170 (D.S.A.)" checked>
                            <span>L. 170 (D.S.A.)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" value="L. 104 (H)" checked>
                            <span>L. 104 (H)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" value="B.E.S." checked>
                            <span>B.E.S.</span>
                        </label>
                    </div>
                </div>
                
                <div class="filter-group">
                    <h4>üîéFiltro per Competenza Linguistica</h4>
                    <div class="checkbox-group" id="competenzeFilters">
                        <label class="checkbox-item">
                            <input type="checkbox" value="Italofono" checked>
                            <span>Italofono</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" value="Livello A" checked>
                            <span>Livello A</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" value="Livello B" checked>
                            <span>Livello B</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" value="Livello Iniziale" checked>
                            <span>Livello Iniziale</span>
                        </label>
                    </div>
                </div>
            </div>
            
            <div class="charts-container" id="chartsContainer">
                <!-- I grafici verranno generati dinamicamente qui -->
            </div>
            
            <div class="chart-actions">
                <button class="btn-chart btn-chart-secondary" onclick="saveAllCharts()">üñºÔ∏è Salva Grafici come immagine</button>
                <button class="btn-chart" onclick="exportChartsReport()">üíæ Esporta Report Completo</button>
            </div>
        </div>
    </div>
    <!-- Overlay di autenticazione -->
    <div id="authOverlay" class="auth-overlay">
        <div class="auth-container">
            <h2>üîê Accesso Docenti IC Puddu</h2>
            <p>Inserisci la tua email @pudduprato.edu.it per accedere alla piattaforma</p>
            
            <div id="loginStep">
                <input type="email" id="emailInput" class="auth-input" placeholder="nome.cognome@pudduprato.edu.it" />
                <button onclick="requestVerificationCode()" class="auth-btn" id="loginBtn">Invia Codice</button>
            </div>
            
            <div id="verifyStep" style="display: none;">
                <p>Controlla la tua email e inserisci il codice ricevuto:</p>
                <input type="text" id="codeInput" class="auth-input" placeholder="Codice a 6 cifre" maxlength="6" />
                <button onclick="verifyCode()" class="auth-btn" id="verifyBtn">Verifica</button>
                <button onclick="backToLogin()" class="auth-btn" style="background: #6c757d;">Indietro</button>
            </div>
            
            <div id="authMessage"></div>
        </div>
    </div>

    <script>
        let studentCounter = 0;
        
        // Configurazione per il sistema di autenticazione
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycby8rheknwj2UQ7hTNUQh4diOau0hMGQCtHv959EnXyKunyK8bW0DhZgne0R0dWatH4LTw/exec'; // Sostituisci con il tuo URL
        let currentSession = null;
        
        document.addEventListener('DOMContentLoaded', function() {
            // Controlla se c'√® una sessione salvata
            const savedSession = localStorage.getItem('icPudduSession');
            if (savedSession) {
                try {
                    const session = JSON.parse(savedSession);
                    if (session.expires > Date.now()) {
                        currentSession = session;
                        showMainApp();
                        return;
                    } else {
                        localStorage.removeItem('icPudduSession');
                    }
                } catch (e) {
                    localStorage.removeItem('icPudduSession');
                }
            }
            
            // Mostra schermata di login
            showLogin();
        });

        function showLogin() {
            document.getElementById('authOverlay').style.display = 'flex';
            document.querySelector('.container').style.filter = 'blur(3px)';
        }

        function showMainApp() {
            document.getElementById('authOverlay').style.display = 'none';
            document.querySelector('.container').style.filter = 'none';
            
            if (currentSession) {
                document.getElementById('userInfo').style.display = 'flex';
                document.getElementById('userEmail').textContent = currentSession.email;
            }
            
            // Crea le righe degli studenti
            for (let i = 1; i <= 30; i++) {
                createEmptyStudentRow(i);
            }
            studentCounter = 30;
            
            setTimeout(() => {
                updateDisciplineFields();
                // Mostra i grafici automaticamente se ci sono dati
                if (checkForData()) {
                    updateCharts();
                }
            }, 200);
        }
        async function requestVerificationCode() {
            const email = document.getElementById('emailInput').value.trim();
            const loginBtn = document.getElementById('loginBtn');
            
            if (!email || !email.endsWith('@pudduprato.edu.it')) {
                showAuthMessage('Usa la tua email @pudduprato.edu.it', 'error');
                return;
            }
            
            loginBtn.disabled = true;
            loginBtn.textContent = 'Invio in corso...';
            
            try {
                const response = await fetch(`${APPS_SCRIPT_URL}?action=login&email=${encodeURIComponent(email)}`);
                const result = await response.json();
                
                if (result.success) {
                    showAuthMessage('Codice inviato! Controlla la tua email: ' + email, 'success');
                    document.getElementById('loginStep').style.display = 'none';
                    document.getElementById('verifyStep').style.display = 'block';
                } else {
                    showAuthMessage(result.message || 'Errore sconosciuto', 'error');
                }
            } catch (error) {
                showAuthMessage('Errore di connessione: ' + error.message, 'error');
            }
            
            loginBtn.disabled = false;
            loginBtn.textContent = 'Invia Codice';
        }

        // Modifica la funzione verifyCode nell'HTML per salvare correttamente il token

        async function verifyCode() {
            const email = document.getElementById('emailInput').value.trim();
            const code = document.getElementById('codeInput').value.trim();
            const verifyBtn = document.getElementById('verifyBtn');
            
            if (!code || code.length !== 6) {
                showAuthMessage('Inserisci il codice a 6 cifre', 'error');
                return;
            }
            
            verifyBtn.disabled = true;
            verifyBtn.textContent = 'Verifica...';
            
            try {
                const response = await fetch(`${APPS_SCRIPT_URL}?action=verify&email=${encodeURIComponent(email)}&code=${encodeURIComponent(code)}`);
                const result = await response.json();
                
                if (result.success) {
                    // Salva ESATTAMENTE come viene ricevuto dal server
                    currentSession = result.data;
                    
                    // Salva in localStorage
                    try {
                        localStorage.setItem('icPudduSession', JSON.stringify(currentSession));
                    } catch (e) {
                        console.error('Errore salvando in localStorage:', e);
                    }
                    
                    showAuthMessage('Accesso autorizzato!', 'success');
                    setTimeout(() => {
                        showMainApp();
                    }, 1000);
                } else {
                    showAuthMessage(result.message, 'error');
                }
            } catch (error) {
                console.error('Errore nella verifica:', error);
                showAuthMessage('Errore di connessione. Riprova.', 'error');
            }
            
            verifyBtn.disabled = false;
            verifyBtn.textContent = 'Verifica';
        }

        function backToLogin() {
            document.getElementById('loginStep').style.display = 'block';
            document.getElementById('verifyStep').style.display = 'none';
            document.getElementById('codeInput').value = '';
            document.getElementById('authMessage').innerHTML = '';
        }

        function showAuthMessage(message, type) {
            const messageDiv = document.getElementById('authMessage');
            messageDiv.innerHTML = `<div class="auth-message auth-${type}">${message}</div>`;
        }

        function logout() {
            localStorage.removeItem('icPudduSession');
            currentSession = null;
            location.reload();
        }
        function createEmptyStudentRow(rowNumber) {
            const tbody = document.getElementById('studentsTableBody');
            const row = document.createElement('tr');
            row.className = 'student-row';
            row.id = `student-${rowNumber}`;
            
            row.innerHTML = `
                <td class="input-cell"><input type="text" placeholder="Cognome" class="form-control" id="cognome-${rowNumber}" oninput="capitalizeInput(this)"></td>
                <td class="input-cell"><input type="text" placeholder="Nome" class="form-control" id="nome-${rowNumber}" oninput="capitalizeInput(this)"></td>
                <td class="input-cell">
                    <select class="form-control" id="certificati-${rowNumber}" onchange="setTimeout(() => { if (checkForData()) updateCharts(); }, 100)">
                        <option value="">-</option>
                        <option value="no">no</option>
                        <option value="L. 170 (D.S.A.)">L. 170 (D.S.A.)</option>
                        <option value="L. 104 (H)">L. 104 (H)</option>
                        <option value="B.E.S.">B.E.S.</option>
                    </select>
                </td>
                <td class="input-cell">
                    <select class="form-control" id="competenze-${rowNumber}" onchange="setTimeout(() => { if (checkForData()) updateCharts(); }, 100)">
                        <option value="">-</option>
                        <option value="Italofono">Italofono</option>
                        <option value="Livello A">Livello A</option>
                        <option value="Livello B">Livello B</option>
                        <option value="Livello Iniziale">Livello Iniziale</option>
                    </select>
                </td>
            `;
            
            // Aggiungi cella media
            const mediaCell = document.createElement('td');
            mediaCell.className = 'input-cell';
            mediaCell.style.textAlign = 'center';
            mediaCell.innerHTML = `<span id="media-${rowNumber}" style="font-weight: bold; color: #1155CC;">-</span>`;
            row.appendChild(mediaCell);
            
            // Aggiungi cella note
            const noteCell = document.createElement('td');
            noteCell.className = 'input-cell';
            noteCell.innerHTML = `<input type="text" placeholder="Note..." id="note-${rowNumber}" style="width: 100%; border: none; padding: 5px;">`;
            row.appendChild(noteCell);
            
            // Aggiungi cella numero riga e pulsante rimuovi
            const actionCell = document.createElement('td');
            actionCell.style.textAlign = 'center';
            actionCell.style.padding = '5px';
            
            actionCell.innerHTML = `
                <div style="display: flex; flex-direction: column; align-items: center; gap: 2px;">
                    <button class="remove-student" onclick="removeStudent(${rowNumber})" style="font-size: 10px; padding: 2px 6px;">Rimuovi</button>
                    <span style="font-size: 11px; color: #666; font-weight: bold;">${rowNumber}</span>
                </div>
            `;
            row.appendChild(actionCell);
            
            tbody.appendChild(row);
        }
        
        // Aggiorna i campi quando cambia la disciplina, ordine o plesso
        document.getElementById('disciplina').addEventListener('change', updateDisciplineFields);
        document.getElementById('ordine').addEventListener('change', updateDisciplineFields);
        
        function updateDisciplineFields() {
            const disciplina = document.getElementById('disciplina').value.toLowerCase();
            const ordine = document.getElementById('ordine').value;
            const isSecondaria = ordine === 'Secondaria I grado';
            
            // Nascondi tutti i campi disciplina
            const allFields = document.querySelectorAll('.discipline-fields');
            allFields.forEach(field => {
                field.classList.remove('active');
                field.style.display = 'none';
            });
            
            // Mostra solo i campi della disciplina selezionata
            if (disciplina === 'matematica' && isSecondaria) {
                // Matematica Secondaria: 4 ambiti
                const disciplineFields = document.querySelectorAll('.matematica-secondaria-fields');
                disciplineFields.forEach(field => {
                    field.classList.add('active');
                    field.style.display = 'table-cell';
                });
            } else if (disciplina === 'matematica') {
                // Matematica Primaria: 3 ambiti
                const disciplineFields = document.querySelectorAll('.matematica-primaria-fields');
                disciplineFields.forEach(field => {
                    field.classList.add('active');
                    field.style.display = 'table-cell';
                });
            } else {
                // Tutte le altre discipline
                const disciplineFields = document.querySelectorAll(`.${disciplina}-fields`);
                disciplineFields.forEach(field => {
                    field.classList.add('active');
                    field.style.display = 'table-cell';
                });
            }
            
            // Aggiorna anche le righe esistenti
            updateExistingRows();
            // Auto-aggiorna i grafici quando cambia la disciplina
            setTimeout(() => {
                if (checkForData()) {
                    updateCharts();
                }
            }, 200);
        }
        function updateExistingRows() {
            // Per ogni riga esistente, rimuovi e ricrea solo le celle disciplina
            const allRows = document.querySelectorAll('#studentsTableBody tr');
            allRows.forEach((row, index) => {
                const studentId = row.id.split('-')[1];
                
                // Salva i valori esistenti prima di ricreare le celle
                const existingValues = {};
                const disciplineCells = row.querySelectorAll('.discipline-cell input');
                disciplineCells.forEach(input => {
                    if (input.id && input.value) {
                        existingValues[input.id] = input.value;
                    }
                });
                
                // Rimuovi tutte le celle disciplina esistenti
                const existingCells = row.querySelectorAll('.discipline-cell');
                existingCells.forEach(cell => cell.remove());
                
                // Riaggiungile con la disciplina corrente
                addDisciplineCellsToRow(row, studentId);
                
                // Ripristina i valori salvati dove possibile
                Object.keys(existingValues).forEach(inputId => {
                    const input = document.getElementById(inputId);
                    if (input) {
                        input.value = existingValues[inputId];
                        // Ricalcola la media dopo aver ripristinato i valori
                        calculateAverage(studentId);
                    }
                });
            });
        }
        
        function validateScore(input) {
            // Rimuovi spazi e caratteri non validi, mantieni solo numeri, virgole e punti
            let cleanValue = input.value.replace(/[^\d,.-]/g, '');
            
            // Sostituisci virgola con punto per il parsing interno
            let normalizedValue = cleanValue.replace(',', '.');
            
            // Previeni input multipli di punti/virgole
            const pointCount = (normalizedValue.match(/\./g) || []).length;
            if (pointCount > 1) {
                // Mantieni solo il primo punto/virgola
                const parts = normalizedValue.split('.');
                normalizedValue = parts[0] + '.' + parts.slice(1).join('');
                // Aggiorna cleanValue per mantenere coerenza
                if (cleanValue.includes(',')) {
                    cleanValue = parts[0] + ',' + parts.slice(1).join('');
                } else {
                    cleanValue = normalizedValue;
                }
            }
            
            // Se l'input √® vuoto o solo un segno meno, permettilo
            if (cleanValue === '' || cleanValue === '-') {
                input.value = cleanValue;
                input.classList.remove('score-warning');
                return;
            }
            
            // Permetti input parziali come "87," o "87."
            if (cleanValue.endsWith(',') || cleanValue.endsWith('.')) {
                input.value = cleanValue;
                input.classList.remove('score-warning');
                return;
            }
            
            const value = parseFloat(normalizedValue);
            
            // Se il valore non √® un numero valido dopo aver escluso i casi speciali sopra
            if (isNaN(value)) {
                input.value = '';
                return;
            }
            
            // Controlla se il valore √® superiore a 100
            if (value > 100) {
                input.value = '100';
                input.classList.add('score-warning');
            } else if (value < 0) {
                // Controlla se il valore √® negativo
                input.value = '0';
                input.style.backgroundColor = '#ffe6e6';
                setTimeout(() => {
                    input.style.backgroundColor = 'white';
                }, 1000);
            } else {
                // Valore valido: mantieni il formato originale dell'utente
                if (value % 1 === 0) {
                    // Se √® un numero intero, mostra senza decimali
                    input.value = Math.floor(value).toString();
                } else {
                    // Per i decimali, mantieni il separatore che l'utente ha digitato
                    if (cleanValue.includes(',') && !cleanValue.includes('.')) {
                        // L'utente ha usato la virgola
                        input.value = value.toString().replace('.', ',');
                    } else {
                        // L'utente ha usato il punto
                        input.value = value.toString();
                    }
                }
                input.classList.remove('score-warning');
            }
        }
        
        function capitalizeInput(input) {
            // Capitalizza la prima lettera di ogni parola
            const words = input.value.split(' ');
            const capitalizedWords = words.map(word => {
                if (word.length > 0) {
                    return word.charAt(0).toUpperCase() + word.slice(1).toLowerCase();
                }
                return word;
            });
            input.value = capitalizedWords.join(' ');
        }
        
        function addStudent() {
            // Incrementa il contatore per aggiungere una nuova riga oltre le 30
            studentCounter++;
            createEmptyStudentRow(studentCounter);
            
            // IMPORTANTE: Aggiungi le celle disciplina per la nuova riga
            const newRow = document.getElementById(`student-${studentCounter}`);
            if (newRow) {
                addDisciplineCellsToRow(newRow, studentCounter);
            }
            
            // Aggiorna la visibilit√† per tutte le righe
            updateDisciplineFields();
        }
        function addDisciplineCellsToRow(row, studentId) {
            const disciplina = document.getElementById('disciplina').value.toLowerCase();
            const ordine = document.getElementById('ordine').value;
            const isSecondaria = ordine === 'Secondaria I grado';
            
            // Se studentId non √® fornito, estrailo dal row ID
            if (!studentId) {
                studentId = row.id.split('-')[1];
            }
            
            // Rimuovi celle discipline esistenti
            const existingCells = row.querySelectorAll('.discipline-cell');
            existingCells.forEach(cell => cell.remove());
            
            // Trova dove inserire le celle (prima della cella media)
            const mediaCell = row.querySelector('span[id^="media-"]')?.parentElement;
            
            if (disciplina === 'inglese') {
                // Solo 2 ambiti per Inglese
                for (let i = 1; i <= 2; i++) {
                    const cell = document.createElement('td');
                    cell.className = 'discipline-cell input-cell inglese-fields';
                    cell.innerHTML = `<input type="text" placeholder="0-100" class="score-input" id="ambito${i}-${studentId}" oninput="validateScore(this); calculateAverage(${studentId})" style="width: 100%; border: none; padding: 5px; text-align: center;">`;
                    row.insertBefore(cell, mediaCell);
                }
            } else if (disciplina === 'italiano') {
                for (let i = 1; i <= 4; i++) {
                    const cell = document.createElement('td');
                    cell.className = 'discipline-cell input-cell italiano-fields';
                    cell.innerHTML = `<input type="text" placeholder="0-100" class="score-input" id="ambito${i}-${studentId}" oninput="validateScore(this); calculateAverage(${studentId})" style="width: 100%; border: none; padding: 5px; text-align: center;">`;
                    row.insertBefore(cell, mediaCell);
                }
            } else if (disciplina === 'matematica' && isSecondaria) {
                // Matematica Secondaria: 4 ambiti
                for (let i = 1; i <= 4; i++) {
                    const cell = document.createElement('td');
                    cell.className = 'discipline-cell input-cell matematica-secondaria-fields';
                    cell.innerHTML = `<input type="text" placeholder="0-100" class="score-input" id="ambito${i}-${studentId}" oninput="validateScore(this); calculateAverage(${studentId})" style="width: 100%; border: none; padding: 5px; text-align: center;">`;
                    row.insertBefore(cell, mediaCell);
                }
            } else if (disciplina === 'matematica') {
                // Matematica Primaria: 3 ambiti
                for (let i = 1; i <= 3; i++) {
                    const cell = document.createElement('td');
                    cell.className = 'discipline-cell input-cell matematica-primaria-fields';
                    cell.innerHTML = `<input type="text" placeholder="0-100" class="score-input" id="ambito${i}-${studentId}" oninput="validateScore(this); calculateAverage(${studentId})" style="width: 100%; border: none; padding: 5px; text-align: center;">`;
                    row.insertBefore(cell, mediaCell);
                }
            } else if (disciplina === 'unica') {
                for (let i = 1; i <= 2; i++) {
                    const cell = document.createElement('td');
                    cell.className = 'discipline-cell input-cell unica-fields';
                    cell.innerHTML = `<input type="text" placeholder="0-100" class="score-input" id="ambito${i}-${studentId}" oninput="validateScore(this); calculateAverage(${studentId})" style="width: 100%; border: none; padding: 5px; text-align: center;">`;
                    row.insertBefore(cell, mediaCell);
                }
            }
        }
        
        function calculateAverage(studentId) {
            const disciplina = document.getElementById('disciplina').value.toLowerCase();
            const ordine = document.getElementById('ordine').value;
            const isSecondaria = ordine === 'Secondaria I grado';
            let scores = [];
            let maxAmbiti = 2;
            
            if (disciplina === 'inglese' || disciplina === 'unica') {
                maxAmbiti = 2;
            } else if (disciplina === 'italiano') {
                maxAmbiti = 4;
            } else if (disciplina === 'matematica' && isSecondaria) {
                maxAmbiti = 4;
            } else if (disciplina === 'matematica') {
                maxAmbiti = 3;
            }
            
            for (let i = 1; i <= maxAmbiti; i++) {
                const input = document.getElementById(`ambito${i}-${studentId}`);
                if (input && input.value !== '') {
                    // Normalizza il valore sostituendo virgola con punto prima del parsing
                    const normalizedValue = input.value.replace(',', '.');
                    const score = parseFloat(normalizedValue);
                    if (!isNaN(score)) {
                        scores.push(score);
                    }
                }
            }
            
            const average = scores.length > 0 ? (scores.reduce((a, b) => a + b, 0) / scores.length).toFixed(1) : '-';
            const mediaElement = document.getElementById(`media-${studentId}`);
            if (mediaElement) {
                mediaElement.textContent = average;
            }

            // Auto-aggiorna i grafici quando cambia una media
            setTimeout(() => {
                if (checkForData()) {
                    updateCharts();
                }
            }, 100);
        }
        
        function removeStudent(studentId) {
            const row = document.getElementById(`student-${studentId}`);
            if (row) {
                // Conferma prima di rimuovere
                if (confirm(`Sei sicuro di voler rimuovere l'alunno ${studentId}?`)) {
                    row.remove();
                }
            }
        }
        
        function clearAll() {
            if (confirm('Sei sicuro di voler cancellare tutti i dati inseriti?')) {
                // Pulisci tutti i campi delle prime 30 righe
                for (let i = 1; i <= 30; i++) {
                    const cognome = document.getElementById(`cognome-${i}`);
                    const nome = document.getElementById(`nome-${i}`);
                    const certificati = document.getElementById(`certificati-${i}`);
                    const competenze = document.getElementById(`competenze-${i}`);
                    const note = document.getElementById(`note-${i}`);
                    const media = document.getElementById(`media-${i}`);
                    
                    if (cognome) cognome.value = '';
                    if (nome) nome.value = '';
                    if (certificati) certificati.value = '';
                    if (competenze) competenze.value = '';
                    if (note) note.value = '';
                    if (media) media.textContent = '-';
                    
                    // Pulisci tutti i punteggi
                    for (let j = 1; j <= 4; j++) {
                        const ambito = document.getElementById(`ambito${j}-${i}`);
                        if (ambito) {
                            ambito.value = '';
                            ambito.classList.remove('score-warning');
                        }
                    }
                }
                
                // Reimposta il contatore al numero di righe effettive o minimo 30
                studentCounter = Math.max(30, document.querySelectorAll('#studentsTableBody tr').length);
            }
        }
        function exportToExcel() {
            const data = collectData();
            const workbook = createWorkbook(data);
            
            // Nome file basato sui dati inseriti
            const anno = document.getElementById('anno').value.replace('/', '');
            const ordine = document.getElementById('ordine').value.split(' ')[0];
            const plesso = document.getElementById('plesso').value.replace('.', '').replace(' ', '');
            const classe = document.getElementById('classe').value || 'X';
            const sezione = document.getElementById('sezione').value || 'X';
            const disciplina = document.getElementById('disciplina').value;
            const prova = document.getElementById('prova').value;
            
            const fileName = `${ordine}_${plesso}_${anno}_${classe}${sezione}_${disciplina}_${prova}.xlsx`;
            
            // Scarica il file
            XLSX.writeFile(workbook, fileName);
        }
        
        function collectData() {
            const data = [];
            const disciplina = document.getElementById('disciplina').value;
            const ordine = document.getElementById('ordine').value;
            const plesso = document.getElementById('plesso').value;
            
            // Intestazione principale
            const headerRow1 = [
                'A.S.',
                document.getElementById('anno').value,
                'SCUOLA:',
                `${ordine} "${plesso}"`,
                'Tabulazione prove parallele IC Puddu',
                '',
                'PROVA:',
                document.getElementById('prova').value,
                'DISCIPLINA:',
                disciplina
            ];
            
            // Intestazione campi
            let headerRow2 = [
                'CLASSE:',
                'SEZIONE:',
                'COGNOME',
                'NOME',
                'CERTIFICATI',
                'COMPETENZE LINGUISTICHE',
                'AMBITO 1',
                'AMBITO 2',
                'AMBITO 3',
                'AMBITO 4',
                'MEDIA'
            ];
            
            // Intestazione ambiti specifici
            let headerRow3 = ['', '', '', '', '', ''];
            
            if (disciplina === 'Inglese') {
                headerRow3.push('Comprensione scritta (Reading)', 'Comprensione orale (Listening)', '', '', '', '');
            } else if (disciplina === 'Italiano') {
                headerRow3.push('Comprensione', 'Inferenze', 'Lessico', 'Grammatica', '', '');
            } else if (disciplina === 'Matematica' && ordine === 'Secondaria I grado') {
                headerRow3.push('Numeri', 'Spazio e Figure', 'Dati e Previsioni', 'Relazioni e Funzioni', '', '');
            } else if (disciplina === 'Matematica') {
                headerRow3.push('Numeri', 'Spazio e Figure', 'Relazioni, dati e previsioni', '', '', '');
            } else if (disciplina === 'Unica') {
                headerRow3.push('Comprensione', 'Classificazione e Orientamento', '', '', '', '');
            }
            
            data.push(headerRow1);
            data.push(headerRow2);
            data.push(headerRow3);
            
            // Dati studenti (solo righe con dati effettivi)
            const allRows = document.querySelectorAll('#studentsTableBody tr');
            allRows.forEach((row, index) => {
                const studentId = row.id.split('-')[1];
                const cognome = document.getElementById(`cognome-${studentId}`)?.value || '';
                const nome = document.getElementById(`nome-${studentId}`)?.value || '';
                const certificati = document.getElementById(`certificati-${studentId}`)?.value || '';
                const competenze = document.getElementById(`competenze-${studentId}`)?.value || '';
                
                // Aggiungi solo righe con almeno cognome o nome compilato
                if (cognome.trim() !== '' || nome.trim() !== '') {
                    let studentRow = [
                        document.getElementById('classe').value,
                        document.getElementById('sezione').value,
                        cognome,
                        nome,
                        certificati,
                        competenze
                    ];
                    
                    // Aggiungi punteggi in base alla disciplina
                    const ordine = document.getElementById('ordine').value;
                    const isSecondaria = ordine === 'Secondaria I grado';
                    
                    if (disciplina === 'Italiano') {
                        for (let j = 1; j <= 4; j++) {
                            const score = document.getElementById(`ambito${j}-${studentId}`)?.value || '';
                            studentRow.push(score);
                        }
                    } else if (disciplina === 'Matematica' && isSecondaria) {
                        // Matematica Secondaria: 4 ambiti
                        for (let j = 1; j <= 4; j++) {
                            const score = document.getElementById(`ambito${j}-${studentId}`)?.value || '';
                            studentRow.push(score);
                        }
                    } else if (disciplina === 'Inglese') {
                        // Inglese: solo 2 ambiti
                        for (let j = 1; j <= 2; j++) {
                            const score = document.getElementById(`ambito${j}-${studentId}`)?.value || '';
                            studentRow.push(score);
                        }
                        studentRow.push('', ''); // Celle vuote per ambiti 3 e 4
                    } else if (disciplina === 'Unica') {
                        for (let j = 1; j <= 2; j++) {
                            const score = document.getElementById(`ambito${j}-${studentId}`)?.value || '';
                            studentRow.push(score);
                        }
                        studentRow.push('', ''); // Celle vuote per ambiti 3 e 4
                    } else {
                        // Matematica Primaria: 3 ambiti
                        for (let j = 1; j <= 3; j++) {
                            const score = document.getElementById(`ambito${j}-${studentId}`)?.value || '';
                            studentRow.push(score);
                        }
                        studentRow.push(''); // Cella vuota per ambito 4
                    }
                    
                    // Media
                    const media = document.getElementById(`media-${studentId}`)?.textContent || '-';
                    studentRow.push(media);
                    
                    // Note
                    const note = document.getElementById(`note-${studentId}`)?.value || '';
                    studentRow.push(note);
                    
                    data.push(studentRow);
                }
            });
            
            return data;
        }
        function createWorkbook(data) {
            const workbook = XLSX.utils.book_new();
            
            // Crea il foglio Input
            const inputWorksheet = XLSX.utils.aoa_to_sheet(data);
            
            // Imposta la larghezza delle colonne per Input
            const colWidths = [
                {wch: 13}, {wch: 13}, {wch: 24}, {wch: 24}, {wch: 14}, {wch: 14},
                {wch: 17}, {wch: 16}, {wch: 16}, {wch: 14}, {wch: 14}, {wch: 20}
            ];
            inputWorksheet['!cols'] = colWidths;
            
            XLSX.utils.book_append_sheet(workbook, inputWorksheet, "Input");
            
            // Crea il foglio Tabelle
            const tabelleData = createTabelleSheet();
            const tabelleWorksheet = XLSX.utils.aoa_to_sheet(tabelleData);
            XLSX.utils.book_append_sheet(workbook, tabelleWorksheet, "Tabelle");
            
            return workbook;
        }
        
        function createTabelleSheet() {
            const disciplina = document.getElementById('disciplina').value;
            const ordine = document.getElementById('ordine').value;
            const plesso = document.getElementById('plesso').value;
            const anno = document.getElementById('anno').value;
            const tipoProva = document.getElementById('prova').value;
            const isSecondaria = ordine === 'Secondaria I grado';
            
            // Prima riga: intestazioni fisse
            const headers = [
                'ID', 'Classe', 'Sezione', 'Anno', 'Plesso', 'Disciplina', 'Tipo_prova',
                'Cognome', 'Nome', 'BES', 'Livello_Linguistico',
                'A1_Nome', 'A1_Punteggi', 'A2_Nome', 'A2_Punteggi',
                'A3_Nome', 'A3_Punteggi', 'A4_Nome', 'A4_Punteggi',
                'MEDIA'
            ];
            
            const tabelleData = [headers];
            
            // Determina i nomi degli ambiti in base alla disciplina
            let ambitiNomi = ['', '', '', ''];
            if (disciplina === 'Inglese') {
                ambitiNomi = ['Comprensione scritta (Reading)', 'Comprensione orale (Listening)', '', ''];
            } else if (disciplina === 'Italiano') {
                ambitiNomi = ['Comprensione', 'Inferenze', 'Lessico', 'Grammatica'];
            } else if (disciplina === 'Matematica' && isSecondaria) {
                ambitiNomi = ['Numeri', 'Spazio e Figure', 'Dati e Previsioni', 'Relazioni e Funzioni'];
            } else if (disciplina === 'Matematica') {
                ambitiNomi = ['Numeri', 'Spazio e Figure', 'Relazioni, dati e previsioni', ''];
            } else if (disciplina === 'Unica') {
                ambitiNomi = ['Comprensione', 'Classificazione e Orientamento', '', ''];
            }
            
            // Costruisci il valore per la colonna Plesso
            const plessoValue = `${ordine} "${plesso}"`;
            
            // Aggiungi i dati degli studenti
            const allRows = document.querySelectorAll('#studentsTableBody tr');
            let idCounter = 1;
            
            allRows.forEach((row, index) => {
                const studentId = row.id.split('-')[1];
                const cognome = document.getElementById(`cognome-${studentId}`)?.value || '';
                const nome = document.getElementById(`nome-${studentId}`)?.value || '';
                
                // Aggiungi solo righe con almeno cognome o nome compilato
                if (cognome.trim() !== '' || nome.trim() !== '') {
                    const certificati = document.getElementById(`certificati-${studentId}`)?.value || '';
                    const competenze = document.getElementById(`competenze-${studentId}`)?.value || '';
                    const classe = document.getElementById('classe').value;
                    const sezione = document.getElementById('sezione').value;
                    
                    // Raccogli i punteggi degli ambiti
                    let ambiti = ['', '', '', ''];
                    if (disciplina === 'Italiano') {
                        for (let j = 1; j <= 4; j++) {
                            ambiti[j-1] = document.getElementById(`ambito${j}-${studentId}`)?.value || '';
                        }
                    } else if (disciplina === 'Matematica' && isSecondaria) {
                        for (let j = 1; j <= 4; j++) {
                            ambiti[j-1] = document.getElementById(`ambito${j}-${studentId}`)?.value || '';
                        }
                    } else if (disciplina === 'Inglese') {
                        for (let j = 1; j <= 2; j++) {
                            ambiti[j-1] = document.getElementById(`ambito${j}-${studentId}`)?.value || '';
                        }
                    } else if (disciplina === 'Unica') {
                        for (let j = 1; j <= 2; j++) {
                            ambiti[j-1] = document.getElementById(`ambito${j}-${studentId}`)?.value || '';
                        }
                    } else if (disciplina === 'Matematica') {
                        for (let j = 1; j <= 3; j++) {
                            ambiti[j-1] = document.getElementById(`ambito${j}-${studentId}`)?.value || '';
                        }
                    }
                    
                    // Media
                    const media = document.getElementById(`media-${studentId}`)?.textContent || '';
                    
                    // Costruisci la riga
                    const studentRow = [
                        idCounter,                    // ID
                        classe,                       // Classe
                        sezione,                      // Sezione
                        anno,                         // Anno
                        plessoValue,                  // Plesso
                        disciplina,                   // Disciplina
                        tipoProva,                    // Tipo_prova
                        cognome,                      // Cognome
                        nome,                         // Nome
                        certificati,                  // BES
                        competenze,                   // Livello_Linguistico
                        ambitiNomi[0],               // A1_Nome
                        ambiti[0],                   // A1_Punteggi
                        ambitiNomi[1],               // A2_Nome
                        ambiti[1],                   // A2_Punteggi
                        ambitiNomi[2],               // A3_Nome
                        ambiti[2],                   // A3_Punteggi
                        ambitiNomi[3],               // A4_Nome
                        ambiti[3],                   // A4_Punteggi
                        media                        // MEDIA
                    ];
                    
                    tabelleData.push(studentRow);
                    idCounter++;
                }
            });
            
            return tabelleData;
        }

        async function transmitData() {
            if (!currentSession) {
                alert('Sessione scaduta. Effettua di nuovo il login.');
                logout();
                return;
            }
            
            const hasData = checkForData();
            if (!hasData) {
                alert('Non ci sono dati da trasmettere. Compila almeno un alunno.');
                return;
            }
            
            const saveBtn = event.target;
            const originalText = saveBtn.textContent;
            saveBtn.disabled = true;
            saveBtn.textContent = 'Trasmissione...';
            
            try {
                const tabulationData = generateTabulationData();
                
                const payload = {
                    action: 'saveData',
                    token: currentSession.token,
                    data: tabulationData
                };
                
                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'text/plain',
                    },
                    body: JSON.stringify(payload)
                });
                
                const responseText = await response.text();
                
                let result;
                try {
                    result = JSON.parse(responseText);
                } catch (e) {
                    result = { success: false, message: 'Errore nella risposta del server' };
                }
                
                if (result.success) {
                    alert('‚úÖ Dati trasmessi con successo nel sistema centralizzato!');
                } else {
                    throw new Error(result.message);
                }
                
            } catch (error) {
                alert('‚ùå Errore nella trasmissione: ' + error.message);
            }
            
            saveBtn.disabled = false;
            saveBtn.textContent = originalText;
        }

        function saveExcel() {
            const hasData = checkForData();
            if (!hasData) {
                alert('Non ci sono dati da salvare. Compila almeno un alunno.');
                return;
            }
            
            exportToExcel();
            alert('üìÅ File Excel salvato con successo!');
        }        
        
        function checkForData() {
            const allRows = document.querySelectorAll('#studentsTableBody tr');
            for (let row of allRows) {
                const studentId = row.id.split('-')[1];
                const cognome = document.getElementById(`cognome-${studentId}`)?.value || '';
                const nome = document.getElementById(`nome-${studentId}`)?.value || '';
                
                if (cognome.trim() !== '' || nome.trim() !== '') {
                    return true;
                }
            }
            return false;
        }

        function generateTabulationData() {
            return {
                metadata: {
                    anno: document.getElementById('anno').value,
                    ordine: document.getElementById('ordine').value,
                    plesso: document.getElementById('plesso').value,
                    classe: document.getElementById('classe').value,
                    sezione: document.getElementById('sezione').value,
                    disciplina: document.getElementById('disciplina').value,
                    prova: document.getElementById('prova').value,
                    timestamp: new Date().toISOString(),
                    docente: currentSession.email
                },
                studenti: collectStudentData()
            };
        }

        function collectStudentData() {
            const studenti = [];
            const allRows = document.querySelectorAll('#studentsTableBody tr');
            
            allRows.forEach((row) => {
                const studentId = row.id.split('-')[1];
                const cognome = document.getElementById(`cognome-${studentId}`)?.value || '';
                const nome = document.getElementById(`nome-${studentId}`)?.value || '';
                
                if (cognome.trim() !== '' || nome.trim() !== '') {
                    const studente = {
                        cognome: cognome,
                        nome: nome,
                        certificati: document.getElementById(`certificati-${studentId}`)?.value || '',
                        competenze: document.getElementById(`competenze-${studentId}`)?.value || '',
                        note: document.getElementById(`note-${studentId}`)?.value || '',
                        media: document.getElementById(`media-${studentId}`)?.textContent || '-',
                        punteggi: {}
                    };
                    
                    // Raccogli i punteggi
                    const disciplina = document.getElementById('disciplina').value.toLowerCase();
                    const ordine = document.getElementById('ordine').value;
                    const isSecondaria = ordine === 'Secondaria I grado';
                    
                    let maxAmbiti = 2;
                    if (disciplina === 'italiano') maxAmbiti = 4;
                    else if (disciplina === 'matematica' && isSecondaria) maxAmbiti = 4;
                    else if (disciplina === 'matematica') maxAmbiti = 3;
                    
                    for (let i = 1; i <= maxAmbiti; i++) {
                        const punteggio = document.getElementById(`ambito${i}-${studentId}`)?.value || '';
                        if (punteggio) {
                            studente.punteggi[`ambito${i}`] = punteggio;
                        }
                    }
                    
                    studenti.push(studente);
                }
            });
            
            return studenti;
        }
        
        function generateFileName() {
            // Genera il nome file (stesso metodo di exportToExcel)
            const anno = document.getElementById('anno').value.replace('/', '');
            const ordine = document.getElementById('ordine').value.split(' ')[0];
            const plesso = document.getElementById('plesso').value.replace('.', '').replace(' ', '');
            const classe = document.getElementById('classe').value || 'X';
            const sezione = document.getElementById('sezione').value || 'X';
            const disciplina = document.getElementById('disciplina').value;
            const prova = document.getElementById('prova').value;
            
            return `${ordine}_${plesso}_${anno}_${classe}${sezione}_${disciplina}_${prova}.xlsx`;
        }
        // === FUNZIONI PER I GRAFICI ===
        let activeCharts = {};

        function updateCharts() {
            // Raccogli i dati filtrati
            const filteredData = getFilteredData();
            
            if (filteredData.length === 0) {
                // Pulisci i grafici se non ci sono dati ma non mostrare l'alert
                const container = document.getElementById('chartsContainer');
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;"><p>I grafici appariranno quando inserisci dei punteggi per gli alunni</p></div>';
                
                // Azzera il riepilogo
                document.getElementById('totalStudents').textContent = '0';
                document.getElementById('overallAverage').textContent = '-';
                
                // Distruggi i grafici esistenti
                Object.values(activeCharts).forEach(chart => {
                    if (chart) chart.destroy();
                });
                activeCharts = {};
                return;
            }
            
            // Aggiorna il riepilogo
            updateStatsSummary(filteredData);
            
            // Genera i grafici
            generateCharts(filteredData);
        }

        function getFilteredData() {
            const allRows = document.querySelectorAll('#studentsTableBody tr');
            const filteredStudents = [];
            
            // Ottieni i filtri selezionati
            const selectedCertificati = Array.from(document.querySelectorAll('#certificatiFilters input:checked')).map(cb => cb.value);
            const selectedCompetenze = Array.from(document.querySelectorAll('#competenzeFilters input:checked')).map(cb => cb.value);
            
            allRows.forEach((row) => {
                const studentId = row.id.split('-')[1];
                const cognome = document.getElementById(`cognome-${studentId}`)?.value?.trim() || '';
                const nome = document.getElementById(`nome-${studentId}`)?.value?.trim() || '';
                
                if (cognome !== '' || nome !== '') {
                    const certificati = document.getElementById(`certificati-${studentId}`)?.value || '';
                    const competenze = document.getElementById(`competenze-${studentId}`)?.value || '';
                    
                    // Applica i filtri
                    const certificatiMatch = selectedCertificati.includes(certificati) || (certificati === '' && selectedCertificati.includes('no'));
                    const competenzeMatch = selectedCompetenze.includes(competenze);
                    
                    if (certificatiMatch && competenzeMatch) {
                        const student = {
                            id: studentId,
                            cognome: cognome,
                            nome: nome,
                            certificati: certificati || 'no',
                            competenze: competenze,
                            punteggi: [],
                            media: parseFloat(document.getElementById(`media-${studentId}`)?.textContent) || 0
                        };
                        
                        // Raccogli i punteggi degli ambiti
                        const disciplina = document.getElementById('disciplina').value.toLowerCase();
                        const ordine = document.getElementById('ordine').value;
                        const isSecondaria = ordine === 'Secondaria I grado';
                        
                        let maxAmbiti = getMaxAmbiti(disciplina, isSecondaria);
                        
                        for (let i = 1; i <= maxAmbiti; i++) {
                            const punteggio = parseFloat(document.getElementById(`ambito${i}-${studentId}`)?.value) || 0;
                            if (punteggio > 0) {
                                student.punteggi.push(punteggio);
                            }
                        }
                        
                        // Aggiungi solo se lo studente ha almeno un punteggio valido E una media calcolata
                        if (student.punteggi.length > 0 && student.media > 0) {
                            filteredStudents.push(student);
                        }
                    }
                }
            });
            
            return filteredStudents;
        }

        function getMaxAmbiti(disciplina, isSecondaria) {
            if (disciplina === 'inglese' || disciplina === 'unica') {
                return 2;
            } else if (disciplina === 'italiano') {
                return 4;
            } else if (disciplina === 'matematica' && isSecondaria) {
                return 4;
            } else if (disciplina === 'matematica') {
                return 3;
            }
            return 2;
        }

        function updateStatsSummary(data) {
            const totalStudents = data.length;
            const overallAverage = totalStudents > 0 ? 
                (data.reduce((sum, student) => sum + student.media, 0) / totalStudents).toFixed(1) : 
                '-';
            
            document.getElementById('totalStudents').textContent = totalStudents;
            document.getElementById('overallAverage').textContent = overallAverage;
        }

        function generateCharts(data) {
            const container = document.getElementById('chartsContainer');
            container.innerHTML = '';
            
            // Distruggi i grafici esistenti
            Object.values(activeCharts).forEach(chart => {
                if (chart) chart.destroy();
            });
            activeCharts = {};
            
            const disciplina = document.getElementById('disciplina').value.toLowerCase();
            const ordine = document.getElementById('ordine').value;
            const isSecondaria = ordine === 'Secondaria I grado';
            const maxAmbiti = getMaxAmbiti(disciplina, isSecondaria);
            
            // Genera grafici per ogni ambito + media
            for (let i = 1; i <= maxAmbiti; i++) {
                createAmbitoChart(container, data, i, disciplina, isSecondaria);
            }
            
            // Grafico della media
            createMediaChart(container, data);
        }
        
        function createAmbitoChart(container, data, ambitoNum, disciplina, isSecondaria) {
            const chartWrapper = document.createElement('div');
            chartWrapper.className = 'chart-wrapper';
            
            // Determina il nome dell'ambito
            const ambitoNames = getAmbitoNames(disciplina, isSecondaria);
            const ambitoName = ambitoNames[ambitoNum - 1] || `Ambito ${ambitoNum}`;
            
            chartWrapper.innerHTML = `
                <div class="chart-title">Ambito ${ambitoNum}<br>${ambitoName}</div>
                <canvas class="chart-canvas" id="chart-ambito${ambitoNum}"></canvas>
            `;
            
            container.appendChild(chartWrapper);
            
            // Raccogli i punteggi per questo ambito
            const scores = data.map(student => {
                return student.punteggi[ambitoNum - 1] || 0;
            }).filter(score => score > 0);
            
            if (scores.length === 0) return;
            
            const average = (scores.reduce((a, b) => a + b, 0) / scores.length).toFixed(1);
            
            // Categorizza i punteggi come nell'immagine
            const categories = {
                'pt. < 25:': scores.filter(s => s < 25).length,
                'pt. < 50:': scores.filter(s => s >= 25 && s < 50).length,
                'pt. < 75:': scores.filter(s => s >= 50 && s < 75).length,
                'pt. ‚â• 75:': scores.filter(s => s >= 75).length
            };
            
            const total = scores.length;
            const percentages = Object.values(categories).map(count => ((count / total) * 100).toFixed(1));
            
            const ctx = document.getElementById(`chart-ambito${ambitoNum}`).getContext('2d');
            
            activeCharts[`ambito${ambitoNum}`] = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(categories),
                    datasets: [{
                        data: Object.values(categories),
                        backgroundColor: ['#ff3300', '#ffcc00', '#99CC66', '#336633'],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                usePointStyle: true,
                                padding: 15,
                                generateLabels: function(chart) {
                                    const data = chart.data;
                                    return data.labels.map((label, i) => ({
                                        text: `${label} ${percentages[i]}%`,
                                        fillStyle: data.datasets[0].backgroundColor[i],
                                        pointStyle: 'circle'
                                    }));
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const percentage = percentages[context.dataIndex];
                                    return `${context.label}: ${context.parsed} studenti (${percentage}%)`;
                                }
                            }
                        }
                    },
                    elements: {
                        center: {
                            text: `pt. medio\n${average}`,
                            color: '#3c78d8',
                            fontStyle: 'bold',
                            sidePadding: 20
                        }
                    }
                },
                plugins: [{
                    beforeDraw: function(chart) {
                        const ctx = chart.ctx;
                        const centerConfig = chart.config.options.elements.center;
                        
                        if (centerConfig) {
                            const centerX = chart.chartArea.left + (chart.chartArea.right - chart.chartArea.left) / 2;
                            const centerY = chart.chartArea.top + (chart.chartArea.bottom - chart.chartArea.top) / 2;
                            
                            ctx.save();
                            ctx.textAlign = 'center';
                            ctx.textBaseline = 'middle';
                            ctx.fillStyle = centerConfig.color;
                            ctx.font = 'bold 14px Ubuntu, sans-serif';
                            
                            const lines = centerConfig.text.split('\n');
                            lines.forEach((line, index) => {
                                const y = centerY + (index - (lines.length - 1) / 2) * 20;
                                ctx.fillText(line, centerX, y);
                            });
                            
                            ctx.restore();
                        }
                    }
                }]
            });
        }

        function createMediaChart(container, data) {
            const chartWrapper = document.createElement('div');
            chartWrapper.className = 'chart-wrapper';
            chartWrapper.innerHTML = `
                <div class="chart-title">Media</div>
                <canvas class="chart-canvas" id="chart-media"></canvas>
            `;
            
            container.appendChild(chartWrapper);
            
            const medias = data.map(student => student.media).filter(media => media > 0);
            
            if (medias.length === 0) return;
            
            const average = (medias.reduce((a, b) => a + b, 0) / medias.length).toFixed(1);
            
            const categories = {
                'pt. < 25:': medias.filter(m => m < 25).length,
                'pt. < 50:': medias.filter(m => m >= 25 && m < 50).length,
                'pt. < 75:': medias.filter(m => m >= 50 && m < 75).length,
                'pt. ‚â• 75:': medias.filter(m => m >= 75).length
            };
            
            const total = medias.length;
            const percentages = Object.values(categories).map(count => ((count / total) * 100).toFixed(1));
            
            const ctx = document.getElementById('chart-media').getContext('2d');
            
            activeCharts['media'] = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(categories),
                    datasets: [{
                        data: Object.values(categories),
                        backgroundColor: ['#ff3300', '#ffcc00', '#99CC66', '#336633'],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                usePointStyle: true,
                                padding: 15,
                                generateLabels: function(chart) {
                                    const data = chart.data;
                                    return data.labels.map((label, i) => ({
                                        text: `${label} ${percentages[i]}%`,
                                        fillStyle: data.datasets[0].backgroundColor[i],
                                        pointStyle: 'circle'
                                    }));
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const percentage = percentages[context.dataIndex];
                                    return `${context.label}: ${context.parsed} studenti (${percentage}%)`;
                                }
                            }
                        }
                    },
                    elements: {
                        center: {
                            text: `pt. medio\n${average}`,
                            color: '#ff6b35',
                            fontStyle: 'bold',
                            sidePadding: 20
                        }
                    }
                },
                plugins: [{
                    beforeDraw: function(chart) {
                        const ctx = chart.ctx;
                        const centerConfig = chart.config.options.elements.center;
                        
                        if (centerConfig) {
                            const centerX = chart.chartArea.left + (chart.chartArea.right - chart.chartArea.left) / 2;
                            const centerY = chart.chartArea.top + (chart.chartArea.bottom - chart.chartArea.top) / 2;
                            
                            ctx.save();
                            ctx.textAlign = 'center';
                            ctx.textBaseline = 'middle';
                            ctx.fillStyle = centerConfig.color;
                            ctx.font = 'bold 16px Ubuntu, sans-serif';
                            
                            const lines = centerConfig.text.split('\n');
                            lines.forEach((line, index) => {
                                const y = centerY + (index - (lines.length - 1) / 2) * 20;
                                ctx.fillText(line, centerX, y);
                            });
                            
                            ctx.restore();
                        }
                    }
                }]
            });
        }
        
        function getAmbitoNames(disciplina, isSecondaria) {
            if (disciplina === 'inglese') {
                return ['Comprensione scritta (Reading)', 'Comprensione orale (Listening)'];
            } else if (disciplina === 'italiano') {
                return ['Comprensione', 'Inferenze', 'Lessico', 'Grammatica'];
            } else if (disciplina === 'matematica' && isSecondaria) {
                return ['Numeri', 'Spazio e Figure', 'Dati e Previsioni', 'Relazioni e Funzioni'];
            } else if (disciplina === 'matematica') {
                return ['Numeri', 'Spazio e Figure', 'Relazioni, dati e previsioni'];
            } else if (disciplina === 'unica') {
                return ['Comprensione', 'Classificazione e Orientamento'];
            }
            return [];
        }

        function saveAllCharts() {
            if (Object.keys(activeCharts).length === 0) {
                alert('Nessun grafico da salvare. I grafici appariranno quando inserisci dei punteggi.');
                return;
            }
            
            // Crea un canvas temporaneo per combinare tutti i grafici
            const combinedCanvas = document.createElement('canvas');
            const ctx = combinedCanvas.getContext('2d');
            
            // Ottieni tutti i wrapper dei grafici
            const chartWrappers = document.querySelectorAll('.chart-wrapper');
            if (chartWrappers.length === 0) return;
            
            // Calcola le dimensioni
            const chartsPerRow = Math.min(3, chartWrappers.length); // Max 3 grafici per riga
            const rows = Math.ceil(chartWrappers.length / chartsPerRow);
            const chartWidth = 400;
            const chartHeight = 650; // Pi√π alto per includere titolo
            const padding = 20;
            
            // Imposta le dimensioni del canvas combinato
            combinedCanvas.width = (chartWidth * chartsPerRow) + (padding * (chartsPerRow + 1));
            combinedCanvas.height = (chartHeight * rows) + (padding * (rows + 1)) + 60; // Extra spazio per intestazione generale
            
            // Sfondo bianco
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, combinedCanvas.width, combinedCanvas.height);
            
            // Aggiungi intestazione generale
            ctx.fillStyle = '#1a49e9';
            ctx.font = 'bold 24px Ubuntu, Arial, sans-serif';
            ctx.textAlign = 'center';
            const disciplina = document.getElementById('disciplina').value;
            const classe = document.getElementById('classe').value;
            const sezione = document.getElementById('sezione').value;
            const headerText = `Analisi Grafici - ${disciplina} - Classe ${classe}${sezione}`;
            ctx.fillText(headerText, combinedCanvas.width / 2, 35);
            
            // Promessa per gestire il caricamento asincrono delle immagini
            const promises = [];
            
            chartWrappers.forEach((wrapper, index) => {
                const canvas = wrapper.querySelector('canvas');
                const title = wrapper.querySelector('.chart-title').textContent;
                
                if (canvas) {
                    const promise = new Promise((resolve) => {
                        // Calcola posizione
                        const col = index % chartsPerRow;
                        const row = Math.floor(index / chartsPerRow);
                        const x = padding + (col * (chartWidth + padding));
                        const y = 70 + padding + (row * (chartHeight + padding)); // 70 per l'intestazione generale
                        
                        // Crea un canvas temporaneo per questo grafico con titolo
                        const tempCanvas = document.createElement('canvas');
                        tempCanvas.width = chartWidth;
                        tempCanvas.height = chartHeight;
                        const tempCtx = tempCanvas.getContext('2d');
                        
                        // Sfondo bianco per il grafico
                        tempCtx.fillStyle = 'white';
                        tempCtx.fillRect(0, 0, chartWidth, chartHeight);
                        
                        // Aggiungi il titolo
                        tempCtx.fillStyle = '#3c78d8';
                        tempCtx.font = 'bold 18px Ubuntu, Arial, sans-serif';
                        tempCtx.textAlign = 'center';
                        
                        // Suddividi il titolo su pi√π righe se necessario
                        const titleLines = title.split('\n');
                        titleLines.forEach((line, lineIndex) => {
                            tempCtx.fillText(line, chartWidth / 2, 25 + (lineIndex * 22));
                        });
                        
                        // Calcola l'area per il grafico (sotto il titolo)
                        const graphArea = {
                            x: 20,
                            y: 60,
                            width: chartWidth - 40,
                            height: chartHeight - 80
                        };
                        
                        // Disegna il grafico ridimensionato
                        tempCtx.drawImage(canvas, 
                            graphArea.x, graphArea.y, 
                            graphArea.width, graphArea.height
                        );
                        
                        // Aggiungi il grafico al canvas combinato
                        ctx.drawImage(tempCanvas, x, y);
                        
                        resolve();
                    });
                    promises.push(promise);
                }
            });
            
            // Quando tutti i grafici sono stati disegnati, salva l'immagine
            Promise.all(promises).then(() => {
                const url = combinedCanvas.toDataURL('image/png');
                const link = document.createElement('a');
                
                // Nome file pi√π descrittivo
                const anno = document.getElementById('anno').value.replace('/', '');
                const ordine = document.getElementById('ordine').value.split(' ')[0];
                const plesso = document.getElementById('plesso').value.replace('.', '').replace(' ', '');
                const prova = document.getElementById('prova').value;
                
                link.download = `Grafici_${disciplina}_${ordine}_${plesso}_${classe}${sezione}_${prova}_${getCurrentDateString()}.png`;
                link.href = url;
                link.click();
                
                alert('‚úÖ Immagine combinata salvata con successo!');
            });
        }

        function exportChartsReport() {
            if (Object.keys(activeCharts).length === 0) {
                alert('Genera prima i grafici per esportare il report.');
                return;
            }
            
            const filteredData = getFilteredData();
            const reportData = generateReportData(filteredData);
            
            // Crea un nuovo workbook per il report
            const workbook = XLSX.utils.book_new();
            
            // Foglio con i dati analizzati
            const reportSheet = XLSX.utils.aoa_to_sheet(reportData);
            XLSX.utils.book_append_sheet(workbook, reportSheet, "Report Analisi");
            
            // Nome file
            const fileName = `Report_Analisi_${getCurrentDateString()}.xlsx`;
            
            // Scarica il file
            XLSX.writeFile(workbook, fileName);
            
            // Salva anche tutti i grafici
            saveAllCharts();
        }

        function generateReportData(data) {
            const disciplina = document.getElementById('disciplina').value;
            const ordine = document.getElementById('ordine').value;
            const anno = document.getElementById('anno').value;
            const classe = document.getElementById('classe').value;
            const sezione = document.getElementById('sezione').value;
            const prova = document.getElementById('prova').value;
            
            const reportData = [
                ['REPORT ANALISI PROVE PARALLELE IC PUDDU'],
                [''],
                ['Anno Scolastico:', anno],
                ['Ordine:', ordine],
                ['Classe/Anno:', classe],
                ['Sezione:', sezione],
                ['Disciplina:', disciplina],
                ['Tipo Prova:', prova],
                ['Data Report:', new Date().toLocaleDateString('it-IT')],
                ['Studenti Analizzati:', data.length],
                [''],
                ['RIEPILOGO STATISTICO'],
                ['Categoria', 'Numero Studenti', 'Percentuale'],
            ];
            
            // Calcola le statistiche per la media
            const medias = data.map(s => s.media).filter(m => m > 0);
            const totalStudents = medias.length;
            
            if (totalStudents > 0) {
                const stats = {
                    'pt. < 25': medias.filter(m => m < 25).length,
                    'pt. < 50': medias.filter(m => m >= 25 && m < 50).length,
                    'pt. < 75': medias.filter(m => m >= 50 && m < 75).length,
                    'pt. ‚â• 75': medias.filter(m => m >= 75).length
                };
                
                Object.entries(stats).forEach(([category, count]) => {
                    const percentage = ((count / totalStudents) * 100).toFixed(1);
                    reportData.push([category, count, `${percentage}%`]);
                });
                
                const overallAverage = (medias.reduce((a, b) => a + b, 0) / totalStudents).toFixed(1);
                reportData.push(['', '', '']);
                reportData.push(['Media Complessiva:', overallAverage, '']);
            }
            
            reportData.push(['']);
            reportData.push(['DETTAGLIO ALUNNI']);
            reportData.push(['Cognome', 'Nome', 'Certificati', 'Comp. Linguistiche', 'Media', 'Ambito 1', 'Ambito 2', 'Ambito 3', 'Ambito 4']);
            
            // Aggiungi i dati degli studenti
            data.forEach(student => {
                const row = [
                    student.cognome,
                    student.nome,
                    student.certificati,
                    student.competenze,
                    student.media
                ];
                
                // Aggiungi i punteggi degli ambiti
                for (let i = 0; i < 4; i++) {
                    row.push(student.punteggi[i] || '');
                }
                
                reportData.push(row);
            });
            
            return reportData;
        }

        function getCurrentDateString() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            
            return `${year}${month}${day}_${hours}${minutes}`;
        }
        // Modifica anche la funzione che carica la sessione salvata
        document.addEventListener('DOMContentLoaded', function() {
            // Controlla se c'√® una sessione salvata
            const savedSession = localStorage.getItem('icPudduSession');
            
            if (savedSession) {
                try {
                    const session = JSON.parse(savedSession);
                    
                    if (session.expires > Date.now()) {
                        currentSession = session;
                        showMainApp();
                        return;
                    } else {
                        localStorage.removeItem('icPudduSession');
                    }
                } catch (e) {
                    console.error('Errore parsing sessione:', e);
                    localStorage.removeItem('icPudduSession');
                }
            }
            
            // Mostra schermata di login
            showLogin();
        });
        // === FINE FUNZIONI GRAFICI ===
    </script>
</body>
</html>
